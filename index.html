<script type="text/babel">
const {useState,useEffect}=React;
const tg=window.Telegram?.WebApp;

const JS_COMPONENTS={
  'Technical Quality':['Posture','Dance Holds','Centre','Balance','Foot Skills','Body Actions','Drive Action','Preparation to Move','Rise and Fall','Swing','Pivots/Pivoting','Skilled Figures'],
  'Movement To Music':['Timing/Shuffle Timing','Rhythm','Musical Structure'],
  'Partnering Skills':['Physical Communication','Overbalance/Counterbalance','Time and Space','Consistency'],
  'Choreography':['Structure','NVC','Positioning','Characterization','Energy','Atmosphere']
};

const DANCES={
  'Waltz':{icon:'üíÉ',classes:['H','E','D','C','B','A','S']},
  'Tango':{icon:'üé©',classes:['H','E','D','C','B','A','S']},
  'Viennese Waltz':{icon:'üéµ',classes:['H','E','D','C','B','A','S']},
  'Slow Foxtrot':{icon:'ü¶ä',classes:['H','E','D','C','B','A','S']},
  'Quickstep':{icon:'‚ö°',classes:['H','E','D','C','B','A','S']}
};

const LEVELS=['E –∫–ª–∞—Å—Å','D –∫–ª–∞—Å—Å','C –∫–ª–∞—Å—Å','B –∫–ª–∞—Å—Å','A –∫–ª–∞—Å—Å','S –∫–ª–∞—Å—Å'];

function App(){
  const [activeTab,setActiveTab]=useState('dashboard');
  const [loading,setLoading]=useState(true);
  const [students,setStudents]=useState([]);
  const [assessments,setAssessments]=useState([]);
  const [criteriaData,setCriteriaData]=useState({});
  const [figuresData,setFiguresData]=useState({});
  const [showModal,setShowModal]=useState(false);
  const [modalType,setModalType]=useState(null);
  const [editingItem,setEditingItem]=useState(null);
  const [form,setForm]=useState({});
  const [toast,setToast]=useState(null);
  const [selectedDance,setSelectedDance]=useState(null);
  const [selectedClass,setSelectedClass]=useState(null);
  const [selectedFigure,setSelectedFigure]=useState(null);
  const [selectedCriteria,setSelectedCriteria]=useState(null);
  const [filters,setFilters]=useState({students:{search:'',level:''}});

  const loadKey=async(key,fallback)=>{
    try{
      if(tg?.CloudStorage){
        return await new Promise(resolve=>{
          tg.CloudStorage.getItem(key,(err,val)=>{
            if(!err && val){
              try{resolve(JSON.parse(val))}catch{resolve(fallback)}
            }else resolve(fallback)
          })
        })
      };
      const raw=localStorage.getItem(key);
      return raw?JSON.parse(raw):fallback
    }catch{return fallback}
  };

  const saveKey=async(key,data)=>{
    try{
      const val=JSON.stringify(data);
      if(tg?.CloudStorage) tg.CloudStorage.setItem(key,val);
      localStorage.setItem(key,val)
    }catch(e){console.error('saveKey error',e)}
  };

  useEffect(()=>{
    (async()=>{
      const [_students,_assessments,_criteria,_figures]=await Promise.all([
        loadKey('students',[{id:1,name:'–ò–≤–∞–Ω–æ–≤ –ê–ª–µ–∫—Å–µ–π',partner:'–ü–µ—Ç—Ä–æ–≤–∞ –ú–∞—Ä–∏—è',level:'D –∫–ª–∞—Å—Å',phone:'+7 900 123-45-67',age:25},{id:2,name:'–°–º–∏—Ä–Ω–æ–≤ –î–º–∏—Ç—Ä–∏–π',partner:'–ö–æ–∑–ª–æ–≤–∞ –ê–Ω–Ω–∞',level:'C –∫–ª–∞—Å—Å',phone:'+7 900 234-56-78',age:27}]),
        loadKey('assessments',[]),
        loadKey('criteriaData',{}),
        loadKey('figuresData',{})
      ]);
      setStudents(_students);
      setAssessments(_assessments);
      setCriteriaData(_criteria);
      setFiguresData(_figures);
      setLoading(false);
      try{tg?.expand && tg.expand()}catch{}
    })()
  },[]);

  useEffect(()=>{if(!loading) saveKey('students',students)},[students]);
  useEffect(()=>{if(!loading) saveKey('assessments',assessments)},[assessments]);
  useEffect(()=>{if(!loading) saveKey('criteriaData',criteriaData)},[criteriaData]);
  useEffect(()=>{if(!loading) saveKey('figuresData',figuresData)},[figuresData]);

  const showToast=(msg,type='success')=>{
    setToast({msg,type});
    setTimeout(()=>setToast(null),3000)
  };

  const openModal=(type,item=null)=>{
    setModalType(type);
    setEditingItem(item);
    setForm(item||{});
    setShowModal(true);
  };

  const closeModal=()=>{setShowModal(false);setForm({});setEditingItem(null);setModalType(null)};

  const saveModal=()=>{
    if(modalType==='student'){
      if(editingItem){
        setStudents(students.map(s=>s.id===editingItem.id?{...form,id:editingItem.id}:s));
        showToast('–û–±–Ω–æ–≤–ª–µ–Ω–æ')
      }else{
        setStudents([...students,{...form,id:Date.now()}]);
        showToast('–î–æ–±–∞–≤–ª–µ–Ω–æ')
      }
    }

    if(modalType==='criteriaNote'){
      const key = `${form.component}_${form.subComponent}`;
      const existingData = criteriaData[key] || {};
      const existingNotes = existingData
