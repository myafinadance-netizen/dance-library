<script type="text/babel">
const {useState,useEffect}=React;
const tg=window.Telegram?.WebApp;

const JS_COMPONENTS={
  'Technical Quality':['Posture','Dance Holds','Centre','Balance','Foot Skills','Body Actions','Drive Action','Preparation to Move','Rise and Fall','Swing','Pivots/Pivoting','Skilled Figures'],
  'Movement To Music':['Timing/Shuffle Timing','Rhythm','Musical Structure'],
  'Partnering Skills':['Physical Communication','Overbalance/Counterbalance','Time and Space','Consistency'],
  'Choreography':['Structure','NVC','Positioning','Characterization','Energy','Atmosphere']
};

const DANCES={
  'Waltz':{icon:'üíÉ',classes:['H','E','D','C','B','A','S']},
  'Tango':{icon:'üé©',classes:['H','E','D','C','B','A','S']},
  'Viennese Waltz':{icon:'üéµ',classes:['H','E','D','C','B','A','S']},
  'Slow Foxtrot':{icon:'ü¶ä',classes:['H','E','D','C','B','A','S']},
  'Quickstep':{icon:'‚ö°',classes:['H','E','D','C','B','A','S']}
};

const LEVELS=['E –∫–ª–∞—Å—Å','D –∫–ª–∞—Å—Å','C –∫–ª–∞—Å—Å','B –∫–ª–∞—Å—Å','A –∫–ª–∞—Å—Å','S –∫–ª–∞—Å—Å'];

function App(){
  const[activeTab,setActiveTab]=useState('dashboard');
  const[loading,setLoading]=useState(true);
  const[students,setStudents]=useState([]);
  const[assessments,setAssessments]=useState([]);
  const[criteriaData,setCriteriaData]=useState({});
  const[figuresData,setFiguresData]=useState({});
  const[showModal,setShowModal]=useState(false);
  const[modalType,setModalType]=useState(null);
  const[editingItem,setEditingItem]=useState(null);
  const[form,setForm]=useState({});
  const[toast,setToast]=useState(null);
  const[selectedDance,setSelectedDance]=useState(null);
  const[selectedClass,setSelectedClass]=useState(null);
  const[selectedFigure,setSelectedFigure]=useState(null);
  const[selectedCriteria,setSelectedCriteria]=useState(null);
  const[filters,setFilters]=useState({students:{search:'',level:''}});

  const loadKey=async(key,fallback)=>{
    try{
      if(tg?.CloudStorage){
        return await new Promise((resolve)=>{
          tg.CloudStorage.getItem(key,(err,val)=>{
            if(!err&&val){
              try{resolve(JSON.parse(val))}catch{resolve(fallback)}
            }else resolve(fallback)
          })
        })
      };
      const raw=localStorage.getItem(key);
      return raw?JSON.parse(raw):fallback
    }catch{return fallback}
  };

  const saveKey=async(key,data)=>{
    try{
      const val=JSON.stringify(data);
      if(tg?.CloudStorage) tg.CloudStorage.setItem(key,val);
      localStorage.setItem(key,val)
    }catch(e){console.error('saveKey error',e)}
  };

  useEffect(()=>{
    (async()=>{
      const [_students,_assessments,_criteria,_figures] = await Promise.all([
        loadKey('students',[{id:1,name:'–ò–≤–∞–Ω–æ–≤ –ê–ª–µ–∫—Å–µ–π',partner:'–ü–µ—Ç—Ä–æ–≤–∞ –ú–∞—Ä–∏—è',level:'D –∫–ª–∞—Å—Å',phone:'+7 900 123-45-67',age:25},{id:2,name:'–°–º–∏—Ä–Ω–æ–≤ –î–º–∏—Ç—Ä–∏–π',partner:'–ö–æ–∑–ª–æ–≤–∞ –ê–Ω–Ω–∞',level:'C –∫–ª–∞—Å—Å',phone:'+7 900 234-56-78',age:27}]),
        loadKey('assessments',[]),
        loadKey('criteriaData',{}),
        loadKey('figuresData',{})
      ]);
      setStudents(_students);
      setAssessments(_assessments);
      setCriteriaData(_criteria);
      setFiguresData(_figures);
      setLoading(false);
      try{tg?.expand && tg.expand()}catch{}
    })()
  },[]);

  useEffect(()=>{if(!loading) saveKey('students',students)},[students]);
  useEffect(()=>{if(!loading) saveKey('assessments',assessments)},[assessments]);
  useEffect(()=>{if(!loading) saveKey('criteriaData',criteriaData)},[criteriaData]);
  useEffect(()=>{if(!loading) saveKey('figuresData',figuresData)},[figuresData]);

  const showToast=(msg,type='success')=>{
    setToast({msg,type});
    setTimeout(()=>setToast(null),3000)
  };

  const openModal=(type,item=null)=>{
    setModalType(type);
    setEditingItem(item);
    setForm(item||{});
    setShowModal(true);
  };

  const closeModal=()=>{setShowModal(false);setForm({});setEditingItem(null);setModalType(null)};

  const saveModal=()=>{
    if(modalType==='student'){
      if(editingItem){
        setStudents(students.map(s=>s.id===editingItem.id?{...form,id:editingItem.id}:s));
        showToast('–û–±–Ω–æ–≤–ª–µ–Ω–æ')
      }else{
        setStudents([...students,{...form,id:Date.now()}]);
        showToast('–î–æ–±–∞–≤–ª–µ–Ω–æ')
      }
    }

    if(modalType==='criteriaNote'){
      const key = `${form.component}_${form.subComponent}`;
      const existingData = criteriaData[key] || {};
      const existingNotes = existingData.notes || [];

      const newNote = {
        id: Date.now(),
        text: form.noteText,
        source: form.source || '–ò—Å—Ç–æ—á–Ω–∏–∫ –Ω–µ —É–∫–∞–∑–∞–Ω',
        date: new Date().toISOString().split('T')[0]
      };

      const updatedNotes = [...existingNotes, newNote];

      const newData = {
        ...criteriaData,
        [key]: {
          ...existingData,
          notes: updatedNotes
        }
      };

      setCriteriaData(newData);
      showToast('–ó–∞–º–µ—Ç–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞');
      closeModal();
      return;
    }

    if(modalType==='figureTechnique'){
      const key=`${form.dance}_${form.class}_${form.figureName}`;
      setFiguresData({...figuresData,[key]:{name:form.figureName,dance:form.dance,class:form.class,technique:form.technique,notes:form.notes}});
      showToast('–¢–µ—Ö–Ω–∏–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞')
    }

    closeModal();
  };

  const deleteItem=(type,id)=>{
    if(!confirm('–£–¥–∞–ª–∏—Ç—å?'))return;
    if(type==='student'){setStudents(students.filter(s=>s.id!==id));showToast('–£–¥–∞–ª–µ–Ω–æ','error')}
  };

  const exportData=()=>{
    const data={students,assessments,criteriaData,figuresData};
    const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
    const url=URL.createObjectURL(blob);
    const a=document.createElement('a');
    a.href=url;
    a.download=`dance-library-${new Date().toISOString().split('T')[0]}.json`;
    a.click();
    URL.revokeObjectURL(url);
    showToast('–≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ')
  };

  const filteredStudents = students.filter(s=>{
    const f=filters.students;
    if(f.search && !s.name.toLowerCase().includes(f.search.toLowerCase()) && !s.partner.toLowerCase().includes(f.search.toLowerCase())) return false;
    if(f.level && s.level!==f.level) return false;
    return true;
  });

  const stats={
    totalStudents:students.length,
    totalCriteria:Object.keys(criteriaData).length,
    totalFigures:Object.keys(figuresData).length
  };

  if(loading) return(<div className="min-h-screen flex items-center justify-center"><div className="text-center"><div className="text-4xl mb-4">üíÉ</div><div className="text-xl">–ó–∞–≥—Ä—É–∑–∫–∞...</div></div></div>);

  return(<div className="min-h-screen p-4 pb-20"><div className="max-w-7xl mx-auto">
    {/* Header */}
    <header className="mb-6 fade-in">
      <div className="flex items-center justify-between mb-4">
        <div>
          <h1 className="text-3xl font-bold bg-gradient-to-r from-purple-400 to-pink-400 bg-clip-text text-transparent">üíÉ –¢–∞–Ω—Ü–µ–≤–∞–ª—å–Ω–∞—è –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞</h1>
          <p className="text-slate-400 text-sm mt-1">WDSF JS 2.1</p>
        </div>
        <button onClick={exportData} className="px-4 py-2 bg-purple-600 rounded-lg text-sm">üìä –≠–∫—Å–ø–æ—Ä—Ç</button>
      </div>
      <nav className="flex gap-2 overflow-x-auto pb-2">
        {[{id:'dashboard',icon:'üìä',label:'–î–∞—à–±–æ—Ä–¥'},{id:'students',icon:'üë•',label:'–£—á–µ–Ω–∏–∫–∏'},{id:'criteria',icon:'üîß',label:'–ö—Ä–∏—Ç–µ—Ä–∏–∏'},{id:'figures',icon:'üìñ',label:'–§–∏–≥—É—Ä—ã'}].map(tab=>(<button key={tab.id} onClick={()=>{setActiveTab(tab.id);setSelectedDance(null);setSelectedClass(null);setSelectedFigure(null);setSelectedCriteria(null)}} className={`px-4 py-2 rounded-lg whitespace-nowrap ${activeTab===tab.id?'bg-gradient-to-r from-purple-600 to-pink-600':'bg-slate-800/50'}`}>{tab.icon} {tab.label}</button>))}
      </nav>
    </header>

    {/* Main */}
    <main className="fade-in">
      {/* –¢—É—Ç –≤–µ—Å—å —Ç–≤–æ–π –∫–æ–¥ –¥–ª—è dashboard, students, criteria, figures –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π */}
      {/* ... */}
    </main>

    {/* Modal */}
    {showModal && (
      <div className="fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4" onClick={closeModal}>
        <div className="bg-slate-800 rounded-xl p-5 w-full max-w-2xl max-h-[90vh] overflow-y-auto" onClick={(e)=>e.stopPropagation()}>
          <div className="flex justify-between items-center mb-4">
            <h3 className="text-xl font-bold">{modalType}</h3>
            <button onClick={closeModal} className="text-slate-400">‚úñ</button>
          </div>
          <div className="space-y-4">
            {/* –ó–¥–µ—Å—å —Ñ–æ—Ä–º—ã –¥–ª—è student, criteriaNote –∏ figureTechnique –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π */}
            {/* ... */}
          </div>
          <div className="flex gap-3 mt-6">
            <button onClick={saveModal} className="flex-1 px-4 py-3 bg-gradient-to-r from-purple-600 to-pink-600 rounded-lg font-bold">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            <button onClick={closeModal} className="px-4 py-3 bg-slate-700 rounded-lg">–û—Ç–º–µ–Ω–∞</button>
          </div>
        </div>
      </div>
    )}

    {/* Toast */}
    {toast && (<div className="fixed bottom-4 right-4 z-50"><div className={`px-4 py-3 rounded-lg shadow-lg ${toast.type==='success'?'bg-green-600':'bg-red-600'}`}>{toast.msg}</div></div>)}
  </div></div>);
}

ReactDOM.render(<App/>,document.getElementById('root'));
</script>
