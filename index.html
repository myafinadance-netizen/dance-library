<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>üíÉ –¢–∞–Ω—Ü–µ–≤–∞–ª—å–Ω–∞—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∞</title>

  <!-- Telegram WebApp -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <!-- React -->
  <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .fade-in { animation: fadeIn .3s ease-out; }
  </style>
</head>

<body class="bg-gradient-to-br from-purple-900 via-slate-900 to-blue-900 text-white">
<div id="root"></div>

<script type="text/babel">
const { useState, useEffect } = React;
const tg = window.Telegram?.WebApp;

/* ================= STORAGE ================= */

const storage = {
  async load(key, fallback) {
    try {
      if (tg?.CloudStorage) {
        return await new Promise(resolve => {
          tg.CloudStorage.getItem(key, (err, value) => {
            if (err || !value) return resolve(fallback);
            try { resolve(JSON.parse(value)); }
            catch { resolve(fallback); }
          });
        });
      }
      const raw = localStorage.getItem(key);
      return raw ? JSON.parse(raw) : fallback;
    } catch {
      return fallback;
    }
  },

  async save(key, data) {
    const value = JSON.stringify(data);
    try {
      if (tg?.CloudStorage) {
        tg.CloudStorage.setItem(key, value, err => {
          if (err) console.error('CloudStorage error:', err);
        });
      }
      localStorage.setItem(key, value);
    } catch (e) {
      console.error('Save error:', e);
    }
  }
};

/* ================= DATA ================= */

const JS_COMPONENTS = {
  "Technical Quality": [
    "Posture","Dance Holds","Centre","Balance","Foot Skills",
    "Body Actions","Drive Action","Preparation to Move",
    "Rise and Fall","Swing","Pivots","Skilled Figures"
  ],
  "Movement To Music": ["Timing","Rhythm","Musical Structure"],
  "Partnering Skills": ["Communication","Balance","Time & Space"],
  "Choreography": ["Structure","Positioning","Energy","Character"]
};

/* ================= APP ================= */

function App() {
  const [loading, setLoading] = useState(true);
  const [criteriaData, setCriteriaData] = useState({});
  const [selectedCriteria, setSelectedCriteria] = useState(null);
  const [showModal, setShowModal] = useState(false);
  const [form, setForm] = useState({});
  const [toast, setToast] = useState(null);

  /* ===== INIT ===== */
  useEffect(() => {
    tg?.ready?.();
    tg?.expand?.();
    document.body.style.overflow = 'hidden';

    (async () => {
      const criteria = await storage.load('criteriaData', {});
      setCriteriaData(criteria);
      setLoading(false);
    })();
  }, []);

  /* ===== SAVE ===== */
  useEffect(() => {
    if (!loading) storage.save('criteriaData', criteriaData);
  }, [criteriaData]);

  const showToast = (msg, type='success') => {
    setToast({ msg, type });
    setTimeout(() => setToast(null), 2500);
  };

  /* ===== SAVE NOTE ===== */
  const saveNote = () => {
    if (!form.component || !form.subComponent || !form.text) {
      showToast('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –∑–∞–º–µ—Ç–∫—É', 'error');
      return;
    }

    const note = {
      id: Date.now(),
      text: form.text,
      source: form.source || '',
      date: new Date().toISOString().split('T')[0]
    };

    setCriteriaData(prev => ({
      ...prev,
      [form.component]: {
        ...(prev[form.component] || {}),
        [form.subComponent]: {
          notes: [
            ...((prev[form.component]?.[form.subComponent]?.notes) || []),
            note
          ]
        }
      }
    }));

    showToast('–ó–∞–º–µ—Ç–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞');
    setShowModal(false);
    setForm({});
  };

  if (loading) {
    return (
      <div className="min-h-screen flex items-center justify-center text-xl">
        –ó–∞–≥—Ä—É–∑–∫–∞...
      </div>
    );
  }

  return (
    <div className="p-4 max-w-3xl mx-auto fade-in">

      {!selectedCriteria && (
        <>
          <h1 className="text-2xl font-bold mb-4">üîß –ö—Ä–∏—Ç–µ—Ä–∏–∏ WDSF</h1>

          {Object.entries(JS_COMPONENTS).map(([group, items]) => (
            <div key={group} className="mb-4">
              <h2 className="text-lg text-purple-400 mb-2">{group}</h2>

              {items.map(item => {
                const count =
                  criteriaData[group]?.[item]?.notes?.length || 0;

                return (
                  <div
                    key={item}
                    onClick={() => setSelectedCriteria({ group, item })}
                    className="p-3 bg-slate-800/50 rounded-lg mb-2 cursor-pointer flex justify-between"
                  >
                    <span>{item}</span>
                    {count > 0 && <span className="text-green-400">{count}</span>}
                  </div>
                );
              })}
            </div>
          ))}
        </>
      )}

      {selectedCriteria && (
        <>
          <button
            onClick={() => setSelectedCriteria(null)}
            className="text-blue-400 mb-3"
          >
            ‚Üê –ù–∞–∑–∞–¥
          </button>

          <h2 className="text-xl font-bold mb-1">
            {selectedCriteria.item}
          </h2>
          <div className="text-sm text-slate-400 mb-4">
            {selectedCriteria.group}
          </div>

          <button
            onClick={() => {
              setForm({
                component: selectedCriteria.group,
                subComponent: selectedCriteria.item
              });
              setShowModal(true);
            }}
            className="mb-4 px-4 py-2 bg-gradient-to-r from-purple-600 to-pink-600 rounded-lg"
          >
            + –î–æ–±–∞–≤–∏—Ç—å –∑–∞–º–µ—Ç–∫—É
          </button>

          {(criteriaData[selectedCriteria.group]
            ?.[selectedCriteria.item]
            ?.notes || []).map(note => (
            <div
              key={note.id}
              className="bg-slate-900/50 p-4 rounded-lg mb-3 border-l-4 border-green-500"
            >
              <div className="text-green-400 text-sm mb-1">
                {note.source || '–ò—Å—Ç–æ—á–Ω–∏–∫ –Ω–µ —É–∫–∞–∑–∞–Ω'}
              </div>
              <div>{note.text}</div>
              <div className="text-xs text-slate-500 mt-2">{note.date}</div>
            </div>
          ))}
        </>
      )}

      {/* MODAL */}
      {showModal && (
        <div className="fixed inset-0 bg-black/70 flex items-center justify-center z-50">
          <div className="bg-slate-800 p-5 rounded-xl w-full max-w-md">
            <h3 className="text-lg font-bold mb-3">–ù–æ–≤–∞—è –∑–∞–º–µ—Ç–∫–∞</h3>

            <input
              className="w-full mb-2 px-3 py-2 bg-slate-900 rounded"
              placeholder="–ò—Å—Ç–æ—á–Ω–∏–∫"
              value={form.source || ''}
              onChange={e => setForm({...form, source: e.target.value})}
            />

            <textarea
              className="w-full mb-4 px-3 py-2 bg-slate-900 rounded"
              rows="5"
              placeholder="–¢–µ–∫—Å—Ç –∑–∞–º–µ—Ç–∫–∏"
              value={form.text || ''}
              onChange={e => setForm({...form, text: e.target.value})}
            />

            <div className="flex gap-2">
              <button
                onClick={saveNote}
                className="flex-1 bg-purple-600 py-2 rounded"
              >
                –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
              </button>
              <button
                onClick={() => setShowModal(false)}
                className="bg-slate-600 px-4 rounded"
              >
                –û—Ç–º–µ–Ω–∞
              </button>
            </div>
          </div>
        </div>
      )}

      {toast && (
        <div className={`fixed bottom-4 right-4 px-4 py-2 rounded-lg ${
          toast.type === 'success' ? 'bg-green-600' : 'bg-red-600'
        }`}>
          {toast.msg}
        </div>
      )}

    </div>
  );
}

ReactDOM.render(<App />, document.getElementById('root'));
</script>
</body>
</html>
